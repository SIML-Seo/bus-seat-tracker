# Vercel Cron 작업 설정

이 문서는 버스 좌석 정보 서비스의 데이터 수집을 위한 Vercel Cron 작업 설정 방법을 설명합니다.

## 개요

버스 위치 및 좌석 정보는 실시간으로 수집되어야 하는 데이터입니다. 이 프로젝트에서는 Vercel의 Cron 작업 기능을 사용하여 정기적으로 데이터를 수집합니다.

원래의 `startOptimizedDataCollection` 함수는 무한 간격(interval)을 사용하여 계속 실행되도록 설계되었으나, 이는 Vercel의 서버리스 환경에 적합하지 않습니다. 따라서 서버리스 환경에 최적화된 `collectDataOnce` 함수를 구현하여 단일 실행 방식으로 변경하였습니다.

## 싱글 실행 vs 인터벌 실행

### 원래 방식 (인터벌 실행)
* `startOptimizedDataCollection` 함수는 `setInterval`을 사용하여 지속적으로 실행
* 시간대와 요일에 따라 동적으로 간격 조정
* 이 방식은 항상 실행 중인 서버 환경에 적합

### 새로운 방식 (싱글 실행)
* `collectDataOnce` 함수는 한 번만 실행되고 종료됨
* Vercel Cron이 5분마다 이 함수를 호출
* 함수 내부에서 시간대와 요일을 기반으로 데이터 수집 범위 결정
* 서버리스 환경에 최적화됨

## 설정 방법

### 1. vercel.json 설정

프로젝트 루트에 다음과 같은 `vercel.json` 파일을 생성합니다:

```json
{
  "crons": [
    {
      "path": "/api/cron/collect-bus-data",
      "schedule": "*/5 * * * *"
    }
  ],
  "functions": {
    "app/api/cron/**/*": {
      "memory": 1024
    }
  }
}
```

* `schedule`: "*/5 * * * *"는 5분마다 실행을 의미합니다
* `memory`: Cron 작업에 할당되는 메모리를 1GB로 설정합니다

### 2. 환경 변수 설정 (선택 사항)

보안을 강화하려면 `.env` 파일에 다음 환경 변수를 추가할 수 있습니다:

```
CRON_SECRET=your_secret_token_here
```

이 설정은 Cron 작업이 승인된 소스에서만 호출되도록 보장합니다.

### 3. Vercel 대시보드 설정

1. Vercel 대시보드에서 프로젝트로 이동합니다.
2. "Settings" > "Cron Jobs"로 이동합니다.
3. Cron 작업이 올바르게 설정되었는지 확인합니다.
4. 필요한 경우 Hobby 계정에서 Pro로 업그레이드하여 더 많은 실행 시간과 더 짧은 간격을 확보합니다.

## 계정별 제한 사항

Vercel의 계정 유형에 따른 Cron 작업 제한:

| 계정 유형 | 최소 간격 | 실행 시간 제한 | 최대 메모리 |
|----------|----------|--------------|-----------|
| Hobby    | 1시간     | 10초         | 1024MB    |
| Pro      | 1분       | 60초         | 4096MB    |
| Enterprise | 1분    | 900초(15분)  | 4096MB    |

## 문제 해결

### 작업이 실행되지 않는 경우
* Vercel 대시보드에서 Cron 작업 로그 확인
* 환경 변수가 올바르게 설정되었는지 확인
* `.env` 파일의 `LOG_LEVEL`을 `debug`로 설정하여 더 자세한 로그 확인

### 데이터가 수집되지 않는 경우
* API 연결 상태 확인
* Supabase 연결 상태 확인
* 데이터베이스 액세스 권한 확인

## 추가 정보

* 오래된 데이터(24시간 이상)는 자동으로 정리됩니다.
* 정리 작업은 30% 확률로 데이터 수집 후 실행됩니다.
* 운영 시간(오전 6시 ~ 오후 10시) 외에는 데이터 수집이 건너뛰어집니다. 